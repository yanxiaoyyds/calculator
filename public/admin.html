<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å†å›¢æ†æ•°è®¡ç®—ç³»ç»Ÿ - ç®¡ç†å‘˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            background: #f0f0f0;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: left;
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .image-link {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px dashed #667eea;
        }

        .image-link:hover {
            color: #764ba2;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .allocation-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .allocation-item input {
            flex: 1;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .bundle-highlight {
            font-weight: bold;
            color: #764ba2;
        }

        .status-submitted {
            color: #28a745;
            font-weight: bold;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-buttons .confirm-btn {
            background: #dc3545;
            color: white;
        }

        .modal-buttons .confirm-btn:hover {
            background: #c82333;
        }

        .modal-buttons .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .modal-buttons .cancel-btn:hover {
            background: #5a6268;
        }

        .admin-tools {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .danger-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        /* ===== ç»„åˆ«ç®¡ç†ä¼˜åŒ– ===== */
        .group-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 12px;
            color: #495057;
        }

        .group-management {
            margin-bottom: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .group-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 15px 0 20px 0;
            padding: 5px 0;
        }

        .group-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .group-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102,126,234,0.15);
        }

        .group-item .remove-group {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #fff;
            transition: all 0.2s;
        }

        .group-item .remove-group:hover {
            background: #dc3545;
            color: white;
        }

        .add-group-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 10px;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(40,167,69,0.2);
        }

        .add-group-btn:hover {
            background: #218838;
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .status-pending-audit {
            color: #fd7e14;
            font-weight: bold;
        }

        .audit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .audit-btn:hover {
            background: #138496;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .reject-btn:hover {
            background: #c82333;
        }

        .image-gallery {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .image-gallery img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .image-gallery img:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .image-preview-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close-preview {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-preview:hover {
            color: #bbb;
        }

        /* ===== ç§»åŠ¨ç«¯é€šç”¨é€‚é… ===== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px;
            }

            .image-gallery {
                max-width: 150px;
            }

            .image-gallery img {
                width: 40px;
                height: 40px;
            }

            /* è¡¨æ ¼æ»šåŠ¨ä¼˜åŒ– */
            .table-container {
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 1000px;
            }

            /* æŒ‰é’®å¤§å°é€‚é…è§¦å± */
            .audit-btn, .reject-btn, .edit-btn, .delete-btn {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
            }

            .close-preview {
                font-size: 50px;
                top: 10px;
                right: 15px;
            }

            /* ç»„åˆ«ç®¡ç†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .group-list {
                gap: 8px;
                margin: 10px 0 15px 0;
            }

            .group-item {
                padding: 6px 12px;
                font-size: 13px;
            }

            .add-group-btn {
                width: 100%;
                padding: 12px;
                font-size: 15px;
            }
        }

        /* å›¾ç‰‡é¢„è§ˆå¼¹çª— - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            touch-action: manipulation;
        }

        .image-preview-content {
            margin: auto;
            display: block;
            max-width: 95%;
            max-height: 95%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            object-fit: contain;
        }

        .close-preview {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            padding: 10px;
            touch-action: manipulation;
        }

        .close-preview:hover {
            color: #bbb;
        }

        /* ===== æ‰‹æœºç«¯ä¼˜åŒ–ï¼ˆè§†å›¾åˆ‡æ¢ã€å¡ç‰‡ç­‰ï¼‰ ===== */
        @media screen and (max-width: 768px) {
            /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
            .view-toggle {
                display: flex;
                gap: 10px;
                margin: 10px 0;
                justify-content: center;
                flex-wrap: wrap;
            }

            .view-btn {
                padding: 8px 20px;
                border: none;
                border-radius: 20px;
                background: #f0f0f0;
                color: #666;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s;
                flex: 1 1 auto;
            }

            .view-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            /* å¯¼å‡ºæŒ‰é’® */
            .export-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 14px;
                cursor: pointer;
                flex: 1 1 auto;
            }

            /* å¡ç‰‡è§†å›¾ */
            .card-view {
                display: none;
            }

            .card-view.active {
                display: block;
            }

            .bundle-card {
                background: white;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border-left: 4px solid #667eea;
            }

            .card-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .card-row:last-child {
                border-bottom: none;
            }

            .card-label {
                color: #666;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .card-value {
                font-weight: bold;
                color: #333;
                font-size: 14px;
            }

            .card-value.highlight {
                color: #764ba2;
                font-size: 16px;
            }

            .status-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
            }

            .status-submitted {
                background: #d4edda;
                color: #155724;
            }

            .status-pending {
                background: #fff3cd;
                color: #856404;
            }

            /* ç®€åŒ–è§†å›¾ */
            .simple-view {
                display: none;
            }

            .simple-view.active {
                display: block;
            }

            .simple-card {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .simple-info {
                display: flex;
                gap: 15px;
                align-items: center;
                flex-wrap: wrap;
            }

            .simple-cn {
                font-weight: bold;
                color: #333;
                min-width: 60px;
            }

            .simple-original {
                color: #764ba2;
                font-weight: bold;
                min-width: 40px;
            }

            .simple-final {
                color: #28a745;
                font-weight: bold;
                min-width: 40px;
            }

            /* ===== ä¿®å¤ç®¡ç†å‘˜åˆ†é…æ˜ç»†å¸ƒå±€ ===== */
            /* åˆ†é…æ˜ç»†é¡¹æ”¹ä¸ºåˆ—å¸ƒå±€ */
            .allocation-item {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            .allocation-item input {
                width: 100%;
                margin-bottom: 5px;
            }

            .allocation-item .remove-btn {
                width: 100%;
                padding: 10px;
            }

            /* ç»„åˆ«è¾“å…¥æ¡†é€‚åº” */
            input[name="group"] {
                width: 100% !important;
                max-width: none !important;
            }

            /* åˆ†é…è¡¨å•æ•´ä½“ä¼˜åŒ– */
            .form-section {
                padding: 15px;
                margin: 10px 0;
            }

            /* æŒ‰é’®é€‚åº” */
            .add-btn, .submit-btn {
                width: 100%;
                margin: 5px 0;
            }

            /* åˆ†é…è®°å½•è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
            #allocationTable {
                min-width: 600px;
            }

            /* æ ‡ç­¾é¡µæŒ‰é’®ä¼˜åŒ– */
            .tab-container {
                flex-wrap: wrap;
                gap: 5px;
            }

            .tab-btn {
                flex: 1 1 auto;
                padding: 10px 8px;
                font-size: 13px;
                white-space: nowrap;
            }
        }

        /* ===== æ†ç‡ç®¡ç†æ ·å¼ ===== */
        /* æ–°å¢æ†ç‡è¡¨å• */
        #newProductCode, #newBundleRate {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        #newProductCode:focus, #newBundleRate:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        #newProductCode {
            text-transform: uppercase; /* è‡ªåŠ¨è½¬å¤§å†™ */
        }

        /* æ†ç‡è¡¨æ ¼æ ·å¼ */
        #ratesTable {
            width: 100%;
            border-collapse: collapse;
        }

        #ratesTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        #ratesTable td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        #ratesTable tr:hover {
            background: #f8f9fa;
        }

        /* æŒ‰é’®æ ·å¼ */
        #ratesTable .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 13px;
            transition: background 0.3s;
        }

        #ratesTable .edit-btn:hover {
            background: #138496;
        }

        #ratesTable .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        #ratesTable .delete-btn:hover {
            background: #c82333;
        }

        /* å¼¹çª—å†…è¾“å…¥æ¡†æ ·å¼ */
        #editProductCode, #editBundleRate {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
        }

        #editProductCode:focus, #editBundleRate:focus {
            outline: none;
            border-color: #667eea;
        }

        /* å•†å“ç¼–å·æ˜¾ç¤ºæ ·å¼ */
        #confirmProductCode, #confirmBundleRate {
            font-weight: bold;
            color: #667eea;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #ratesTable {
                font-size: 13px;
            }

            #ratesTable th,
            #ratesTable td {
                padding: 8px 10px;
            }

            #ratesTable .edit-btn,
            #ratesTable .delete-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            #newProductCode, #newBundleRate {
                padding: 8px 10px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š å°å†å›¢æ†æ•°è®¡ç®—ç³»ç»Ÿ - ç®¡ç†å‘˜é¢æ¿</h1>

    <!-- ç®¡ç†å‘˜å·¥å…· -->
    <div class="admin-tools">
        <button class="danger-btn" onclick="showClearDatabaseModal()">æ¸…ç©ºæ•°æ®åº“</button>
    </div>


    <div class="tab-container">
        <button class="tab-btn active" onclick="showTab('bundle')">å›¢å‘˜æ†è¡¨</button>
        <button class="tab-btn" onclick="showTab('audit')">å¾…å®¡æ ¸</button>
        <button class="tab-btn" onclick="showTab('allocation')">ä¸Šæ†</button>
        <button class="tab-btn" onclick="showTab('groups')">ç»„åˆ«ç®¡ç†</button>
        <button class="tab-btn" onclick="showTab('rates')">ğŸ”¢ æ†ç‡ç®¡ç†</button>  <!-- æ–°å¢ -->

    </div>

    <div id="alert" class="alert"></div>

    <!-- æ¸…ç©ºæ•°æ®åº“å¼¹çª— -->
    <div id="clearDatabaseModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ æ¸…ç©ºæ•°æ®åº“</h3>
            <p>æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼</p>
            <p>è¯·è¾“å…¥ <strong>"æˆ‘ç¡®å®šæ¸…ç©º"</strong> ç¡®è®¤ï¼š</p>
            <input type="text" id="clearConfirmInput" placeholder="æˆ‘ç¡®å®šæ¸…ç©º">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideClearDatabaseModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="clearDatabase()">ç¡®è®¤æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- å®¡æ ¸å¼¹çª— -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“‹ å®¡æ ¸æäº¤</h3>
            <div id="auditContent"></div>
            <div class="modal-buttons">
                <button class="reject-btn" onclick="rejectSubmission()">æ‹’ç»</button>
                <button class="audit-btn" onclick="approveSubmission()">é€šè¿‡</button>
                <button class="cancel-btn" onclick="hideAuditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç»„åˆ«å¼¹çª— -->
    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <h3>â• æ·»åŠ ç»„åˆ«</h3>
            <p>è¾“å…¥æ–°ç»„åˆ«åç§°ï¼š</p>
            <input type="text" id="newGroupName" placeholder="ä¾‹å¦‚: E" maxlength="1">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideAddGroupModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="addGroup()">æ·»åŠ </button>
            </div>
        </div>
    </div>


    <div id="bundleTab" class="tab-content active">
        <h2>ğŸ“‹ å›¢å‘˜æ†è¡¨</h2>

        <!-- æ‰‹æœºç«¯è§†å›¾åˆ‡æ¢ (æ”¾åœ¨è¡¨æ ¼ä¸Šé¢) -->
        <div class="view-toggle" id="viewToggle">
            <button class="view-btn active" onclick="switchView('table')">è¡¨æ ¼</button>
            <button class="view-btn" onclick="switchView('card')">å¡ç‰‡</button>
            <button class="view-btn" onclick="switchView('simple')">ç®€æ´</button>
            <button class="export-btn" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
        </div>

        <div class="table-container">
            <table id="bundleTable">
                <thead>
                <tr>
                    <th>CN</th>
                    <th>ç»„åˆ«</th>
                    <th>åˆ†é…åˆ¶å“</th>
                    <th>åˆ†é…æ•°é‡</th>
                    <th>æ†ç‡</th>
                    <th>åŸæ†</th>
                    <th>æäº¤çŠ¶æ€</th>
                    <th>æ¨è½¦ç±»å‹</th>
                    <th>æ¨è½¦æ˜ç»†</th>
                    <th>æ¨è½¦å›¾</th>
                    <th>è‡ªå¸¦å†·æ˜ç»†</th>
                    <th>è‡ªå¸¦å†·å›¾</th>
                    <th>è§£æ†</th>
                    <th>åæ†</th>
                </tr>
                </thead>
                <tbody id="bundleBody">
                <tr>
                    <td colspan="14" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="auditTab" class="tab-content">
        <h2>â³ å¾…å®¡æ ¸æäº¤</h2>
        <div class="table-container">
            <table id="auditTable">
                <thead>
                <tr>
                    <th>CN</th>
                    <th>ç»„åˆ«</th>
                    <th>æ¨è½¦ç±»å‹</th>
                    <th>æ¨è½¦æ˜ç»†</th>
                    <th>æ¨è½¦å›¾</th>
                    <th>è‡ªå¸¦å†·æ˜ç»†</th>
                    <th>è‡ªå¸¦å†·å›¾</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="auditBody">
                <tr>
                    <td colspan="9" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="allocationTab" class="tab-content">
        <h2>ğŸ“¦ æ†æ•°åˆ†é…</h2>
        <div class="form-section">
            <form id="allocationForm">
                <div class="form-group">
                    <label>ç»„åˆ«ï¼š</label>
                    <input type="text" name="group" placeholder="eg A" maxlength="1" pattern="[A-Da-d]" style="width: 100px;" required>
                    <small style="color: #666; display: block; margin-top: 5px;">è¾“å…¥å•ä¸ªå¤§å†™å­—æ¯å³å¯ï¼ˆA/B/C/Dï¼‰</small>
                </div>

                <div class="form-group">
                    <label for="productCode">å«æ†åˆ¶å“ï¼š</label>
                    <select id="productCode" name="productCode" required>
                        <option value="">è¯·é€‰æ‹©åˆ¶å“</option>
                        <option value="A1">A1 (1k2)</option>
                        <option value="C2">C2 (1k2)</option>
                        <option value="C4">C4 (1k2)</option>
                        <option value="C8">C8 (1k2)</option>
                        <option value="B15">B15 (1k2)</option>
                        <option value="A4">A4 (1k1)</option>
                        <option value="B5">B5 (1k1)</option>
                        <option value="A10">A10 (1k1)</option>
                        <option value="C12">C12 (1k1)</option>
                        <option value="B16">B16 (1k1)</option>
                        <option value="C14">C14 (1k1)</option>
                        <option value="C7">C7 (1k1)</option>
                    </select>
                </div>

                <h3>åˆ†é…æ˜ç»†</h3>
                <div id="allocationItems">
                    <div class="allocation-item">
                        <input type="text" name="allocationCn" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    </div>
                </div>
                <button type="button" class="add-btn" onclick="addAllocationItem()">+ æ·»åŠ åˆ†é…</button>

                <div class="form-actions">
                    <button type="submit" class="submit-btn">æäº¤åˆ†é…</button>
                </div>
            </form>
        </div>

        <h2>ğŸ“œ åˆ†é…è®°å½•</h2>
        <div class="table-container">
            <table id="allocationTable">
                <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç»„åˆ«</th>
                    <th>åˆ¶å“</th>
                    <th>åˆ†é…è¯¦æƒ…</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="allocationBody">
                <tr>
                    <td colspan="5" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="groupsTab" class="tab-content">
        <h2>ğŸ‘¥ ç»„åˆ«ç®¡ç†</h2>
        <div class="form-section">
            <div class="group-management">
                <h3>å½“å‰ç»„åˆ«</h3>
                <div id="groupList" class="group-list">
                    <!-- ç»„åˆ«åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                </div>
                <button class="add-group-btn" onclick="showAddGroupModal()">+ æ·»åŠ ç»„åˆ«</button>
            </div>
        </div>
    </div>

    <div id="ratesTab" class="tab-content">
        <h2>ğŸ”¢ æ†ç‡ç®¡ç†</h2>

        <!-- æ–°å¢æ†ç‡è¡¨å• -->
        <div class="form-section">
            <h3>â• æ–°å¢æ†ç‡è§„åˆ™</h3>
            <div class="form-group">
                <label>å•†å“ç¼–å·ï¼š</label>
                <input type="text" id="newProductCode" placeholder="ä¾‹å¦‚: C7" maxlength="3" style="width: 120px;">
                <small style="color: #666; display: block;">è¾“å…¥å•†å“ç¼–å·ï¼Œå¦‚ A1ã€B15ã€C7</small>
            </div>
            <div class="form-group">
                <label>æ†ç‡ï¼š</label>
                <select id="newBundleRate" style="width: 120px;">
                    <option value="0">æ— æ† (0)</option>
                    <option value="1">1k1 (æ†1)</option>
                    <option value="2">1k2 (æ†2)</option>
                    <option value="3">1k3 (æ†3)</option>
                    <option value="4">1k4 (æ†4)</option>
                </select>
            </div>
            <button class="add-btn" onclick="showAddRateModal()">æ·»åŠ æ†ç‡è§„åˆ™</button>
        </div>

        <!-- å½“å‰æ†ç‡åˆ—è¡¨ -->
        <h3>ğŸ“‹ å½“å‰æ†ç‡è§„åˆ™</h3>
        <div class="table-container">
            <table id="ratesTable">
                <thead>
                <tr>
                    <th>å•†å“ç¼–å·</th>
                    <th>æ†ç‡</th>
                    <th>è¯´æ˜</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="ratesBody">
                <tr>
                    <td colspan="4" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ·»åŠ æ†ç‡ç¡®è®¤å¼¹çª— -->
    <div id="addRateModal" class="modal">
        <div class="modal-content">
            <h3>ç¡®è®¤æ·»åŠ æ†ç‡è§„åˆ™</h3>
            <p>å•†å“ç¼–å·: <span id="confirmProductCode"></span></p>
            <p>æ†ç‡: <span id="confirmBundleRate"></span></p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideAddRateModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="addRate()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ†ç‡å¼¹çª— -->
    <div id="editRateModal" class="modal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æ†ç‡è§„åˆ™</h3>
            <input type="hidden" id="editRateId">
            <div class="form-group">
                <label>å•†å“ç¼–å·ï¼š</label>
                <input type="text" id="editProductCode" readonly style="background:#f0f0f0;">
            </div>
            <div class="form-group">
                <label>æ†ç‡ï¼š</label>
                <select id="editBundleRate">
                    <option value="0">æ— æ† (0)</option>
                    <option value="1">1k1 (æ†1)</option>
                    <option value="2">1k2 (æ†2)</option>
                    <option value="3">1k3 (æ†3)</option>
                    <option value="4">1k4 (æ†4)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideEditRateModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="updateRate()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div id="deleteRateModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
            <p>ç¡®å®šè¦åˆ é™¤å•†å“ <span id="deleteProductCode"></span> çš„æ†ç‡è§„åˆ™å—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideDeleteRateModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="confirmDeleteRate()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="this.style.display='none'">
        <span class="close-preview" onclick="document.getElementById('imagePreviewModal').style.display='none'">&times;</span>
        <img class="image-preview-content" id="previewImage">
    </div>
</div>

<script>

    // ç»„åˆ«æ•°æ®ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
    var groups = ['A', 'B', 'C', 'D'];


    // æ˜¾ç¤ºæ ‡ç­¾é¡µ
    function showTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');

        if (tabName === 'allocation') {
            loadAllocations();
            updateGroupSelect();
        } else if (tabName === 'bundle') {
            loadBundleTable();
        } else if (tabName === 'audit') {
            loadPendingSubmissions();
        } else if (tabName === 'groups') {
            loadGroups();
        }
    }


    // åŠ è½½ç»„åˆ«åˆ—è¡¨
    function loadGroups() {
        var container = document.getElementById('groupList');
        var html = '';
        groups.forEach(function(group) {
            html += `
                <div class="group-item">
                    ${group}ç»„
                    <span class="remove-group" onclick="removeGroup('${group}')">âœ•</span>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // æ˜¾ç¤ºæ·»åŠ ç»„åˆ«å¼¹çª—
    function showAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'block';
        document.getElementById('newGroupName').value = '';
    }

    function hideAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'none';
    }

    // æ·»åŠ ç»„åˆ«
    function addGroup() {
        var newGroup = document.getElementById('newGroupName').value.toUpperCase();
        if (!newGroup || newGroup.length !== 1) {
            showAlert('ç»„åˆ«å¿…é¡»æ˜¯å•ä¸ªå¤§å†™å­—æ¯', 'error');
            return;
        }
        if (groups.includes(newGroup)) {
            showAlert('ç»„åˆ«å·²å­˜åœ¨', 'error');
            return;
        }
        groups.push(newGroup);
        groups.sort();
        loadGroups();
        updateGroupSelect();
        hideAddGroupModal();
        showAlert('ç»„åˆ«æ·»åŠ æˆåŠŸ', 'success');
    }

    // åˆ é™¤ç»„åˆ«
    function removeGroup(group) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤ç»„åˆ« ' + group + ' å—ï¼Ÿ')) {
            return;
        }
        groups = groups.filter(g => g !== group);
        loadGroups();
        updateGroupSelect();
        showAlert('ç»„åˆ«å·²åˆ é™¤', 'success');
    }

    // æ˜¾ç¤ºæ¸…ç©ºæ•°æ®åº“å¼¹çª—
    function showClearDatabaseModal() {
        document.getElementById('clearDatabaseModal').style.display = 'block';
        document.getElementById('clearConfirmInput').value = '';
    }

    function hideClearDatabaseModal() {
        document.getElementById('clearDatabaseModal').style.display = 'none';
    }

    // æ¸…ç©ºæ•°æ®åº“
    function clearDatabase() {
        var confirmText = document.getElementById('clearConfirmInput').value;

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/clear-database', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('æ•°æ®åº“å·²æ¸…ç©ºï¼', 'success');
                    hideClearDatabaseModal();
                    // åˆ·æ–°æ‰€æœ‰è¡¨æ ¼
                    loadBundleTable();
                    loadAllocations();
                    loadPendingSubmissions();
                } else {
                    showAlert('æ¸…ç©ºå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            confirmText: confirmText
        }));
    }

    // åŠ è½½å¾…å®¡æ ¸æäº¤
    function loadPendingSubmissions() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/pending-submissions', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    var tbody = document.getElementById('auditBody');

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— å¾…å®¡æ ¸æäº¤</td></tr>';
                        return;
                    }

                    var html = '';
                    for (var i = 0; i < data.length; i++) {
                        var sub = data[i];
                        var date = new Date(sub.createdAt).toLocaleString('zh-CN');

                        // æ ¼å¼åŒ–æ¨è½¦æ˜ç»†
                        var pushDetails = '';
                        if (sub.pushDetails && sub.pushDetails.length > 0) {
                            pushDetails = sub.pushDetails.map(d => d.productCode + ':' + d.quantity).join(', ');
                        } else {
                            pushDetails = 'æ— ';
                        }

                        // æ ¼å¼åŒ–è‡ªå¸¦å†·æ˜ç»†
                        var coldDetails = '';
                        if (sub.selfColdDetails && sub.selfColdDetails.length > 0) {
                            coldDetails = sub.selfColdDetails.map(d => d.productCode + ':' + d.quantity).join(', ');
                        } else {
                            coldDetails = 'æ— ';
                        }

                        // ä½¿ç”¨ _id è€Œä¸æ˜¯ id
                        html += '<tr>' +
                            '<td>' + sub.cn + '</td>' +
                            '<td>' + sub.group_text + '</td>' +
                            '<td>' + sub.pushType + '</td>' +
                            '<td>' + pushDetails + '</td>' +
                            '<td>' + formatImageGallery(sub.pushImages) + '</td>' +
                            '<td>' + coldDetails + '</td>' +
                            '<td>' + formatImageGallery(sub.selfColdImages) + '</td>' +
                            '<td>' + date + '</td>' +
                            '<td>' +
                            '<button class="audit-btn" onclick="approveSubmission(\'' + sub._id + '\')">é€šè¿‡</button>' +
                            '<button class="reject-btn" onclick="rejectSubmission(\'' + sub._id + '\')">æ‹’ç»</button>' +
                            '</td>' +
                            '</tr>';
                    }
                    tbody.innerHTML = html;
                } else {
                    console.error('åŠ è½½å¾…å®¡æ ¸æäº¤å¤±è´¥:', xhr.status);
                    document.getElementById('auditBody').innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">åŠ è½½å¤±è´¥</td></tr>';
                }
            }
        };
        xhr.send();
    }

    // æ˜¾ç¤ºå®¡æ ¸å¼¹çª—
    function showAuditModal(id) {
        var submission = pendingSubmissions.find(s => s.id === id);
        if (!submission) return;

        var content = document.getElementById('auditContent');
        content.innerHTML = `
            <p><strong>CN:</strong> ${submission.cn}</p>
            <p><strong>ç»„åˆ«:</strong> ${submission.group}</p>
            <p><strong>æ¨è½¦ç±»å‹:</strong> ${submission.pushType}</p>
            <p><strong>æ¨è½¦æ˜ç»†:</strong> ${submission.pushDetails || 'æ— '}</p>
            <p><strong>è‡ªå¸¦å†·æ˜ç»†:</strong> ${submission.selfColdDetails || 'æ— '}</p>
        `;

        document.getElementById('auditModal').style.display = 'block';
        window.currentAuditId = id;
    }

    function hideAuditModal() {
        document.getElementById('auditModal').style.display = 'none';
    }

    // é€šè¿‡å®¡æ ¸
    function approveSubmission(id) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/approve-submission/' + id, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('å®¡æ ¸é€šè¿‡ï¼', 'success');
                    loadPendingSubmissions();  // åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
                    loadBundleTable();          // åˆ·æ–°æ†è¡¨
                } else {
                    showAlert('æ“ä½œå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // æ‹’ç»å®¡æ ¸
    function rejectSubmission(id) {
        if (!confirm('ç¡®å®šè¦æ‹’ç»è¿™æ¡æäº¤å—ï¼Ÿ')) {
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/admin/reject-submission/' + id, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('å·²æ‹’ç»', 'success');
                    loadPendingSubmissions();  // åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
                } else {
                    showAlert('æ“ä½œå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message, type) {
        var alert = document.getElementById('alert');
        alert.className = 'alert ' + type;
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(function() {
            alert.style.display = 'none';
        }, 3000);
    }


    // åŠ è½½å›¢å‘˜æ†è¡¨
    function loadBundleTable() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/bundle-table', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var tbody = document.getElementById('bundleBody');
                // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºè§†å›¾åˆ‡æ¢
                tbody.dataset.rawData = JSON.stringify(data);
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14" style="text-align: center;">æš‚æ— åˆ†é…è®°å½•</td></tr>';
                    return;
                }

                var html = '';
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var statusClass = item.status === 'å·²æäº¤' ? 'status-submitted' : 'status-pending';

                    // åœ¨ loadBundleTable å‡½æ•°ä¸­ï¼Œä¿®æ”¹å›¾ç‰‡æ˜¾ç¤ºéƒ¨åˆ†
                    html += '<tr>' +
                        '<td><strong>' + item.cn + '</strong></td>' +
                        '<td>' + item.group + '</td>' +
                        '<td>' + item.productCode + '</td>' +
                        '<td>' + item.quantity + '</td>' +
                        '<td>' + (item.rate > 0 ? '1k' + item.rate : 'æ— æ†') + '</td>' +
                        '<td class="bundle-highlight">' + item.originalBundles + '</td>' +
                        '<td class="' + statusClass + '">' + item.status + '</td>' +
                        '<td>' + (item.pushType || '') + '</td>' +
                        '<td>' + (item.pushDetails || '') + '</td>' +
                        '<td>' + formatImageGallery(item.pushImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                        '<td>' + (item.selfColdDetails || '') + '</td>' +
                        '<td>' + formatImageGallery(item.selfColdImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                        '<td class="bundle-highlight">' + (item.releaseBundles || 0) + '</td>' +
                        '<td class="bundle-highlight">' + (item.finalBundles || 0) + '</td>' +
                        '</tr>';
                }
                tbody.innerHTML = html;
            }
        };
        xhr.send();
    }
    // æ ¼å¼åŒ–å›¾ç‰‡æ˜¾ç¤ºä¸ºç¼©ç•¥å›¾åˆ—è¡¨
    function formatImageGallery(images) {
        if (!images || images.length === 0) return 'æ— ';

        var html = '<div class="image-gallery">';
        for (var i = 0; i < images.length; i++) {
            var imgUrl = '/uploads/' + images[i];
            html += '<img src="' + imgUrl + '" onclick="previewImage(\'' + imgUrl + '\');event.stopPropagation();">';
        }
        html += '</div>';
        return html;
    }

    // å›¾ç‰‡é¢„è§ˆå‡½æ•°
    function previewImage(src) {
        document.getElementById('previewImage').src = src;
        document.getElementById('imagePreviewModal').style.display = 'block';
    }
    // åŠ è½½åˆ†é…è®°å½•
    function loadAllocations() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/allocations', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var tbody = document.getElementById('allocationBody');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš‚æ— åˆ†é…è®°å½•</td></tr>';
                    return;
                }

                var html = '';
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.createdAt).toLocaleString('zh-CN');
                    var details = '';
                    for (var j = 0; j < item.allocations.length; j++) {
                        if (j > 0) details += 'ï¼Œ';
                        details += item.allocations[j].cn + ':' + item.allocations[j].quantity;
                    }

                    html += '<tr>' +
                        '<td>' + date + '</td>' +
                        '<td>' + item.group_text + '</td>' +
                        '<td>' + item.productCode + '</td>' +
                        '<td>' + details + '</td>' +
                        '<td>' +
                        // ä½¿ç”¨ _id
                        '<button class="edit-btn" onclick="editAllocation(\'' + item._id + '\')">ç¼–è¾‘</button>' +
                        '<button class="delete-btn" onclick="deleteAllocation(\'' + item._id + '\')">åˆ é™¤</button>' +
                        '</td>' +
                        '</tr>';
                }
                tbody.innerHTML = html;
            }
        };
        xhr.send();
    }

    // åˆ é™¤åˆ†é…
    function deleteAllocation(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åˆ†é…è®°å½•å—ï¼Ÿ')) {
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/admin/allocations/' + id, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                    loadAllocations();
                    loadBundleTable();  // åˆ·æ–°æ†è¡¨
                    // è§¦å‘é‡æ–°è®¡ç®—
                    fetch('/api/admin/recalculate-all', { method: 'POST' });
                } else {
                    showAlert('åˆ é™¤å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // ç¼–è¾‘åˆ†é…
    function editAllocation(id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/allocations', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var allocation = data.find(a => a._id === id);

                if (allocation) {
                    // ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ text input è€Œä¸æ˜¯ select
                    document.querySelector('input[name="group"]').value = allocation.group_text;
                    document.getElementById('productCode').value = allocation.productCode;

                    var container = document.getElementById('allocationItems');
                    container.innerHTML = '';

                    for (var i = 0; i < allocation.allocations.length; i++) {
                        var item = allocation.allocations[i];
                        var newItem = document.createElement('div');
                        newItem.className = 'allocation-item';
                        newItem.innerHTML = `
                        <input type="text" name="allocationCn" value="${item.cn}" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" value="${item.quantity}" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    `;
                        container.appendChild(newItem);
                    }

                    var form = document.getElementById('allocationForm');
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        updateAllocation(id);
                    };

                    showTab('allocation');
                }
            }
        };
        xhr.send();
    }

    // æ›´æ–°åˆ†é…
    function updateAllocation(id) {
        var groupInput = document.querySelector('input[name="group"]');
        var group = groupInput.value.toUpperCase();

        var productCode = document.getElementById('productCode').value;
        var allocationCns = document.getElementsByName('allocationCn');
        var allocationQtys = document.getElementsByName('allocationQuantity');

        var allocations = [];
        for (var i = 0; i < allocationCns.length; i++) {
            if (allocationCns[i].value && allocationQtys[i].value) {
                allocations.push({
                    cn: allocationCns[i].value,
                    quantity: parseInt(allocationQtys[i].value)
                });
            }
        }

        if (allocations.length === 0) {
            showAlert('è¯·è‡³å°‘å¡«å†™ä¸€æ¡åˆ†é…', 'error');
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('PUT', '/api/admin/allocations/' + id, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('æ›´æ–°æˆåŠŸï¼', 'success');

                    document.getElementById('allocationForm').reset();
                    document.getElementById('allocationItems').innerHTML = `
                <div class="allocation-item">
                    <input type="text" name="allocationCn" placeholder="CN" required>
                    <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                    <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                </div>
            `;

                    document.getElementById('allocationForm').onsubmit = function(e) {
                        e.preventDefault();
                        submitAllocation();
                    };

                    loadAllocations();
                    loadBundleTable();
                    // è§¦å‘é‡æ–°è®¡ç®—
                    fetch('/api/admin/recalculate-all', { method: 'POST' });
                } else {
                    showAlert('æ›´æ–°å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            group: group,
            productCode: productCode,
            allocations: allocations
        }));
    }

    // æ·»åŠ åˆ†é…é¡¹
    function addAllocationItem() {
        var container = document.getElementById('allocationItems');
        var newItem = document.createElement('div');
        newItem.className = 'allocation-item';
        newItem.innerHTML = `
            <input type="text" name="allocationCn" placeholder="CN" required>
            <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
            <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
        `;
        container.appendChild(newItem);
    }

    // åˆ é™¤åˆ†é…é¡¹
    function removeAllocationItem(btn) {
        var item = btn.parentElement;
        if (item.parentElement.children.length > 1) {
            item.remove();
        } else {
            showAlert('è‡³å°‘ä¿ç•™ä¸€é¡¹', 'error');
        }
    }

    // æäº¤åˆ†é…
    function submitAllocation() {
        // ä¿®æ”¹è¿™é‡Œï¼šä» text input è·å–å€¼
        var groupInput = document.querySelector('input[name="group"]');
        var group = groupInput.value.toUpperCase();

        var productCode = document.getElementById('productCode').value;
        var allocationCns = document.getElementsByName('allocationCn');
        var allocationQtys = document.getElementsByName('allocationQuantity');

        var allocations = [];
        for (var i = 0; i < allocationCns.length; i++) {
            if (allocationCns[i].value && allocationQtys[i].value) {
                allocations.push({
                    cn: allocationCns[i].value,
                    quantity: parseInt(allocationQtys[i].value)
                });
            }
        }

        if (allocations.length === 0) {
            showAlert('è¯·è‡³å°‘å¡«å†™ä¸€æ¡åˆ†é…', 'error');
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/allocations', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('åˆ†é…æäº¤æˆåŠŸï¼', 'success');
                    document.getElementById('allocationForm').reset();
                    document.getElementById('allocationItems').innerHTML = `
                    <div class="allocation-item">
                        <input type="text" name="allocationCn" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    </div>
                `;
                    loadAllocations();
                    loadBundleTable();
                } else {
                    showAlert('æäº¤å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            group: group,
            productCode: productCode,
            allocations: allocations
        }));
    }

    document.getElementById('allocationForm').onsubmit = function(e) {
        e.preventDefault();
        submitAllocation();
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadBundleTable();
    });
    // è§†å›¾åˆ‡æ¢
    function switchView(mode) {
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const tableView = document.querySelector('.table-container');
        const cardView = document.getElementById('cardView');
        const simpleView = document.getElementById('simpleView');

        if (mode === 'table') {
            tableView.style.display = 'block';
            if (cardView) cardView.style.display = 'none';
            if (simpleView) simpleView.style.display = 'none';
        } else if (mode === 'card') {
            tableView.style.display = 'none';
            if (cardView) cardView.style.display = 'block';
            if (simpleView) simpleView.style.display = 'none';
            renderCardView();
        } else if (mode === 'simple') {
            tableView.style.display = 'none';
            if (cardView) cardView.style.display = 'none';
            if (simpleView) simpleView.style.display = 'block';
            renderSimpleView();
        }
    }

    // æ¸²æŸ“å¡ç‰‡è§†å›¾
    function renderCardView() {
        const data = JSON.parse(document.getElementById('bundleBody').dataset.rawData || '[]');
        let html = '<div id="cardView" class="card-view active">';
        data.forEach(item => {
            const statusClass = item.status === 'å·²æäº¤' ? 'status-submitted' : 'status-pending';
            html += `
            <div class="bundle-card">
                <div class="card-row">
                    <span class="card-label">ğŸ‘¤ CN</span>
                    <span class="card-value"><strong>${item.cn}</strong></span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ“ ç»„åˆ«</span>
                    <span class="card-value">${item.group}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ“¦ åˆ†é…</span>
                    <span class="card-value">${item.productCode}:${item.quantity}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ”¢ åŸæ†</span>
                    <span class="card-value highlight">${item.originalBundles}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ›’ æ¨è½¦</span>
                    <span class="card-value">${item.pushDetails || 'æ— '}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">â„ï¸ è‡ªå¸¦å†·</span>
                    <span class="card-value">${item.selfColdDetails || 'æ— '}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ“¸ æ¨è½¦å›¾</span>
                    <span class="card-value">${formatImageGallery(item.pushImages)}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ“¸ è‡ªå¸¦å†·å›¾</span>
                    <span class="card-value">${formatImageGallery(item.selfColdImages)}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">âœ… è§£æ†</span>
                    <span class="card-value highlight">${item.releaseBundles}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ åæ†</span>
                    <span class="card-value highlight">${item.finalBundles}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">ğŸ“Š çŠ¶æ€</span>
                    <span class="card-value"><span class="status-badge ${statusClass}">${item.status}</span></span>
                </div>
            </div>
        `;
        });
        html += '</div>';

        // æ’å…¥åˆ°è¡¨æ ¼åé¢
        const container = document.querySelector('.container');
        const existingCardView = document.getElementById('cardView');
        if (existingCardView) existingCardView.remove();
        container.insertAdjacentHTML('beforeend', html);
    }

    // æ¸²æŸ“ç®€æ´è§†å›¾ (CN åŸæ† åæ†)
    function renderSimpleView() {
        const data = JSON.parse(document.getElementById('bundleBody').dataset.rawData || '[]');
        let html = '<div id="simpleView" class="simple-view">';
        data.forEach(item => {
            html += `
            <div class="simple-card">
                <div class="simple-info">
                    <span class="simple-cn">${item.cn}</span>
                    <span class="simple-original">åŸ:${item.originalBundles}</span>
                    <span class="simple-final">å:${item.finalBundles}</span>
                </div>
                <span class="status-badge ${item.status === 'å·²æäº¤' ? 'status-submitted' : 'status-pending'}">${item.status}</span>
            </div>
        `;
        });
        html += '</div>';

        const container = document.querySelector('.container');
        const existingSimpleView = document.getElementById('simpleView');
        if (existingSimpleView) existingSimpleView.remove();
        container.insertAdjacentHTML('beforeend', html);
    }

    // å¯¼å‡º CSV
    function exportToCSV() {
        const data = JSON.parse(document.getElementById('bundleBody').dataset.rawData || '[]');
        let csv = 'CN,ç»„åˆ«,åˆ†é…åˆ¶å“,åˆ†é…æ•°é‡,åŸæ†,æ¨è½¦ç±»å‹,æ¨è½¦æ˜ç»†,è‡ªå¸¦å†·æ˜ç»†,è§£æ†,åæ†,çŠ¶æ€\n';

        data.forEach(item => {
            csv += `${item.cn},${item.group},${item.productCode},${item.quantity},${item.originalBundles},${item.pushType || ''},"${item.pushDetails || ''}","${item.selfColdDetails || ''}",${item.releaseBundles},${item.finalBundles},${item.status}\n`;
        });

        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `æ†æ•°ç»Ÿè®¡_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
    // ===== æ†ç‡ç®¡ç† =====
    let rateToDelete = null;

    // åŠ è½½æ†ç‡åˆ—è¡¨
    function loadRates() {
        fetch('/api/admin/rates')
            .then(res => res.json())
            .then(data => {
                var tbody = document.getElementById('ratesBody');
                var html = '';

                data.forEach(item => {
                    var rateText = item.rate === 0 ? 'æ— æ†' : '1k' + item.rate;
                    html += '<tr>' +
                        '<td><strong>' + item.productCode + '</strong></td>' +
                        '<td>' + rateText + '</td>' +
                        '<td>' + (item.rate === 0 ? 'æ— éœ€æ†' : 'ä¹°1æ†' + item.rate) + '</td>' +
                        '<td>' +
                        '<button class="edit-btn" onclick="showEditRateModal(\'' + item.productCode + '\', ' + item.rate + ')">ç¼–è¾‘</button> ' +
                        '<button class="delete-btn" onclick="showDeleteRateModal(\'' + item.productCode + '\')">åˆ é™¤</button>' +
                        '</td>' +
                        '</tr>';
                });

                tbody.innerHTML = html;
            })
            .catch(err => {
                console.error('åŠ è½½æ†ç‡å¤±è´¥:', err);
                document.getElementById('ratesBody').innerHTML = '<tr><td colspan="4" style="color: red;">åŠ è½½å¤±è´¥</td></tr>';
            });
    }

    // æ˜¾ç¤ºæ·»åŠ å¼¹çª—
    function showAddRateModal() {
        var code = document.getElementById('newProductCode').value.toUpperCase().trim();
        var rate = document.getElementById('newBundleRate').value;

        if (!code) {
            showAlert('è¯·è¾“å…¥å•†å“ç¼–å·', 'error');
            return;
        }

        // éªŒè¯æ ¼å¼ï¼ˆå­—æ¯+æ•°å­—ï¼‰
        if (!/^[A-Za-z]\d+$/.test(code)) {
            showAlert('å•†å“ç¼–å·æ ¼å¼åº”ä¸ºå­—æ¯+æ•°å­—ï¼Œå¦‚ A1', 'error');
            return;
        }

        document.getElementById('confirmProductCode').textContent = code;
        document.getElementById('confirmBundleRate').textContent = rate === '0' ? 'æ— æ†' : '1k' + rate;
        document.getElementById('addRateModal').style.display = 'block';
    }

    function hideAddRateModal() {
        document.getElementById('addRateModal').style.display = 'none';
    }

    // æ·»åŠ æ†ç‡
    function addRate() {
        var code = document.getElementById('confirmProductCode').textContent;
        var rate = document.getElementById('newBundleRate').value;

        fetch('/api/admin/rates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productCode: code, rate: rate })
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    showAlert('æ·»åŠ æˆåŠŸï¼', 'success');
                    hideAddRateModal();
                    document.getElementById('newProductCode').value = '';
                    loadRates();
                    updateProductSelect();
                    // è§¦å‘é‡æ–°è®¡ç®—
                    fetch('/api/admin/recalculate-all', { method: 'POST' });
                } else {
                    showAlert('æ·»åŠ å¤±è´¥ï¼š' + result.error, 'error');
                }
            });
    }

    // æ˜¾ç¤ºç¼–è¾‘å¼¹çª—
    function showEditRateModal(code, rate) {
        document.getElementById('editRateId').value = code;
        document.getElementById('editProductCode').value = code;
        document.getElementById('editBundleRate').value = rate.toString();
        document.getElementById('editRateModal').style.display = 'block';
    }

    function hideEditRateModal() {
        document.getElementById('editRateModal').style.display = 'none';
    }

    // æ›´æ–°æ†ç‡
    function updateRate() {
        var code = document.getElementById('editRateId').value;
        var rate = document.getElementById('editBundleRate').value;

        fetch('/api/admin/rates/' + code, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rate: rate })
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    showAlert('ä¿®æ”¹æˆåŠŸï¼', 'success');
                    hideEditRateModal();
                    loadRates();
                    updateProductSelect();
                    fetch('/api/admin/recalculate-all', { method: 'POST' });
                } else {
                    showAlert('ä¿®æ”¹å¤±è´¥ï¼š' + result.error, 'error');
                }
            });
    }

    // æ˜¾ç¤ºåˆ é™¤å¼¹çª—
    function showDeleteRateModal(code) {
        document.getElementById('deleteProductCode').textContent = code;
        document.getElementById('deleteRateModal').style.display = 'block';
        rateToDelete = code;
    }

    function hideDeleteRateModal() {
        document.getElementById('deleteRateModal').style.display = 'none';
        rateToDelete = null;
    }

    // ç¡®è®¤åˆ é™¤
    function confirmDeleteRate() {
        if (!rateToDelete) return;

        fetch('/api/admin/rates/' + rateToDelete, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                    hideDeleteRateModal();
                    loadRates();
                    updateProductSelect();
                    fetch('/api/admin/recalculate-all', { method: 'POST' });
                } else {
                    showAlert('åˆ é™¤å¤±è´¥ï¼š' + result.error, 'error');
                }
            });
    }

    // æ›´æ–°æ‰€æœ‰æ†ç‡ä¸‹æ‹‰æ¡†
    function updateProductSelect() {
        fetch('/api/admin/rates')
            .then(res => res.json())
            .then(rates => {
                var select = document.getElementById('productCode');
                var currentValue = select.value;

                var html = '<option value="">è¯·é€‰æ‹©åˆ¶å“</option>';
                rates.forEach(item => {
                    var rateText = item.rate === 0 ? 'æ— æ†' : '1k' + item.rate;
                    html += '<option value="' + item.productCode + '">' + item.productCode + ' (' + rateText + ')</option>';
                });

                select.innerHTML = html;
                if (currentValue) {
                    select.value = currentValue;
                }
            });
    }

    // åœ¨ showTab ä¸­æ·»åŠ  rates çš„å¤„ç†
    function showTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');

        if (tabName === 'allocation') {
            loadAllocations();
            updateProductSelect();  // æ›´æ–°ä¸‹æ‹‰æ¡†
        } else if (tabName === 'bundle') {
            loadBundleTable();
        } else if (tabName === 'audit') {
            loadPendingSubmissions();
        } else if (tabName === 'groups') {
            loadGroups();
        } else if (tabName === 'rates') {
            loadRates();
        }
    }

    // åœ¨ DOMContentLoaded ä¸­åŠ è½½æ†ç‡
    document.addEventListener('DOMContentLoaded', function() {
        loadBundleTable();
        updateProductSelect();  // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    });
</script>
</body>
</html>
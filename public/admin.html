<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å†å›¢æ†æ•°è®¡ç®—ç³»ç»Ÿ - ç®¡ç†å‘˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            background: #f0f0f0;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: left;
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .image-link {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px dashed #667eea;
        }

        .image-link:hover {
            color: #764ba2;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .allocation-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .allocation-item input {
            flex: 1;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .bundle-highlight {
            font-weight: bold;
            color: #764ba2;
        }

        .status-submitted {
            color: #28a745;
            font-weight: bold;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-buttons .confirm-btn {
            background: #dc3545;
            color: white;
        }

        .modal-buttons .confirm-btn:hover {
            background: #c82333;
        }

        .modal-buttons .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .modal-buttons .cancel-btn:hover {
            background: #5a6268;
        }

        .admin-tools {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .danger-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .group-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 12px;
            color: #495057;
        }

        .add-group-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }

        .add-group-btn:hover {
            background: #218838;
        }

        .group-management {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .group-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .group-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .group-item .remove-group {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }

        .group-item .remove-group:hover {
            color: #c82333;
        }

        .status-pending-audit {
            color: #fd7e14;
            font-weight: bold;
        }

        .audit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .audit-btn:hover {
            background: #138496;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .reject-btn:hover {
            background: #c82333;
        }
        .image-gallery {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .image-gallery img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .image-gallery img:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .image-preview-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close-preview {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-preview:hover {
            color: #bbb;
        }
        /* ç§»åŠ¨ç«¯å›¾ç‰‡ç”»å»Š */
        .image-gallery {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .image-gallery img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .image-gallery img:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .image-gallery {
                max-width: 150px;
            }

            .image-gallery img {
                width: 40px;
                height: 40px;
            }

            /* è¡¨æ ¼æ»šåŠ¨ä¼˜åŒ– */
            .table-container {
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 1000px; /* ç¡®ä¿è¡¨æ ¼å¯ä»¥æ¨ªå‘æ»šåŠ¨ */
            }

            /* æŒ‰é’®å¤§å°é€‚é…è§¦å± */
            .audit-btn, .reject-btn, .edit-btn, .delete-btn {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
            }
        }

        /* å›¾ç‰‡é¢„è§ˆå¼¹çª— - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            touch-action: manipulation;
        }

        .image-preview-content {
            margin: auto;
            display: block;
            max-width: 95%;
            max-height: 95%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            object-fit: contain;
        }

        .close-preview {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            padding: 10px;
            touch-action: manipulation;
        }

        .close-preview:hover {
            color: #bbb;
        }

        /* ç§»åŠ¨ç«¯å…³é—­æŒ‰é’®æ›´å¤§ */
        @media (max-width: 768px) {
            .close-preview {
                font-size: 50px;
                top: 10px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š å°å†å›¢æ†æ•°è®¡ç®—ç³»ç»Ÿ - ç®¡ç†å‘˜é¢æ¿</h1>

    <!-- ç®¡ç†å‘˜å·¥å…· -->
    <div class="admin-tools">
        <button class="danger-btn" onclick="showClearDatabaseModal()">æ¸…ç©ºæ•°æ®åº“</button>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="showTab('bundle')">å›¢å‘˜æ†è¡¨</button>
        <button class="tab-btn" onclick="showTab('audit')">å¾…å®¡æ ¸æäº¤</button>
        <button class="tab-btn" onclick="showTab('allocation')">æ†æ•°åˆ†é…</button>
        <button class="tab-btn" onclick="showTab('groups')">ç»„åˆ«ç®¡ç†</button>
    </div>

    <div id="alert" class="alert"></div>

    <!-- æ¸…ç©ºæ•°æ®åº“å¼¹çª— -->
    <div id="clearDatabaseModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ æ¸…ç©ºæ•°æ®åº“</h3>
            <p>æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼</p>
            <p>è¯·è¾“å…¥ <strong>"æˆ‘ç¡®å®šæ¸…ç©º"</strong> ç¡®è®¤ï¼š</p>
            <input type="text" id="clearConfirmInput" placeholder="æˆ‘ç¡®å®šæ¸…ç©º">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideClearDatabaseModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="clearDatabase()">ç¡®è®¤æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- å®¡æ ¸å¼¹çª— -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“‹ å®¡æ ¸æäº¤</h3>
            <div id="auditContent"></div>
            <div class="modal-buttons">
                <button class="reject-btn" onclick="rejectSubmission()">æ‹’ç»</button>
                <button class="audit-btn" onclick="approveSubmission()">é€šè¿‡</button>
                <button class="cancel-btn" onclick="hideAuditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç»„åˆ«å¼¹çª— -->
    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <h3>â• æ·»åŠ ç»„åˆ«</h3>
            <p>è¾“å…¥æ–°ç»„åˆ«åç§°ï¼š</p>
            <input type="text" id="newGroupName" placeholder="ä¾‹å¦‚: E" maxlength="1">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideAddGroupModal()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="addGroup()">æ·»åŠ </button>
            </div>
        </div>
    </div>


    <div id="bundleTab" class="tab-content active">
        <h2>ğŸ“‹ å›¢å‘˜æ†è¡¨</h2>
        <div class="table-container">
            <table id="bundleTable">
                <thead>
                <tr>
                    <th>CN</th>
                    <th>ç»„åˆ«</th>
                    <th>åˆ†é…åˆ¶å“</th>
                    <th>åˆ†é…æ•°é‡</th>
                    <th>æ†ç‡</th>
                    <th>åŸæ†</th>
                    <th>æäº¤çŠ¶æ€</th>
                    <th>æ¨è½¦ç±»å‹</th>
                    <th>æ¨è½¦æ˜ç»†</th>
                    <th>æ¨è½¦å›¾</th>
                    <th>è‡ªå¸¦å†·æ˜ç»†</th>
                    <th>è‡ªå¸¦å†·å›¾</th>
                    <th>è§£æ†</th>
                    <th>åæ†</th>
                </tr>
                </thead>
                <tbody id="bundleBody">
                <tr>
                    <td colspan="14" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="auditTab" class="tab-content">
        <h2>â³ å¾…å®¡æ ¸æäº¤</h2>
        <div class="table-container">
            <table id="auditTable">
                <thead>
                <tr>
                    <th>CN</th>
                    <th>ç»„åˆ«</th>
                    <th>æ¨è½¦ç±»å‹</th>
                    <th>æ¨è½¦æ˜ç»†</th>
                    <th>æ¨è½¦å›¾</th>
                    <th>è‡ªå¸¦å†·æ˜ç»†</th>
                    <th>è‡ªå¸¦å†·å›¾</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="auditBody">
                <tr>
                    <td colspan="9" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="allocationTab" class="tab-content">
        <h2>ğŸ“¦ æ†æ•°åˆ†é…</h2>
        <div class="form-section">
            <form id="allocationForm">
                <div class="form-group">
                    <label>ç»„åˆ«ï¼š</label>
                    <input type="text" name="group" placeholder="eg A" maxlength="1" pattern="[A-Da-d]" style="width: 100px;" required>
                    <small style="color: #666; display: block; margin-top: 5px;">è¾“å…¥å•ä¸ªå¤§å†™å­—æ¯å³å¯ï¼ˆA/B/C/Dï¼‰</small>
                </div>

                <div class="form-group">
                    <label for="productCode">å«æ†åˆ¶å“ï¼š</label>
                    <select id="productCode" name="productCode" required>
                        <option value="">è¯·é€‰æ‹©åˆ¶å“</option>
                        <option value="A1">A1 (1k2)</option>
                        <option value="C2">C2 (1k2)</option>
                        <option value="C4">C4 (1k2)</option>
                        <option value="C8">C8 (1k2)</option>
                        <option value="B15">B15 (1k2)</option>
                        <option value="A4">A4 (1k1)</option>
                        <option value="B5">B5 (1k1)</option>
                        <option value="A10">A10 (1k1)</option>
                        <option value="C12">C12 (1k1)</option>
                        <option value="B16">B16 (1k1)</option>
                        <option value="C14">C14 (1k1)</option>
                        <option value="C7">C7 (1k1)</option>
                    </select>
                </div>

                <h3>åˆ†é…æ˜ç»†</h3>
                <div id="allocationItems">
                    <div class="allocation-item">
                        <input type="text" name="allocationCn" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    </div>
                </div>
                <button type="button" class="add-btn" onclick="addAllocationItem()">+ æ·»åŠ åˆ†é…</button>

                <div class="form-actions">
                    <button type="submit" class="submit-btn">æäº¤åˆ†é…</button>
                </div>
            </form>
        </div>

        <h2>ğŸ“œ åˆ†é…è®°å½•</h2>
        <div class="table-container">
            <table id="allocationTable">
                <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç»„åˆ«</th>
                    <th>åˆ¶å“</th>
                    <th>åˆ†é…è¯¦æƒ…</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="allocationBody">
                <tr>
                    <td colspan="5" class="loading">åŠ è½½ä¸­...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="groupsTab" class="tab-content">
        <h2>ğŸ‘¥ ç»„åˆ«ç®¡ç†</h2>
        <div class="form-section">
            <div class="group-management">
                <h3>å½“å‰ç»„åˆ«</h3>
                <div id="groupList" class="group-list">
                    <!-- ç»„åˆ«åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                </div>
                <button class="add-group-btn" onclick="showAddGroupModal()">+ æ·»åŠ ç»„åˆ«</button>
            </div>
        </div>
    </div>
    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="this.style.display='none'">
        <span class="close-preview" onclick="document.getElementById('imagePreviewModal').style.display='none'">&times;</span>
        <img class="image-preview-content" id="previewImage">
    </div>
</div>

<script>

    // ç»„åˆ«æ•°æ®ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
    var groups = ['A', 'B', 'C', 'D'];


    // æ˜¾ç¤ºæ ‡ç­¾é¡µ
    function showTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');

        if (tabName === 'allocation') {
            loadAllocations();
            updateGroupSelect();
        } else if (tabName === 'bundle') {
            loadBundleTable();
        } else if (tabName === 'audit') {
            loadPendingSubmissions();
        } else if (tabName === 'groups') {
            loadGroups();
        }
    }


    // åŠ è½½ç»„åˆ«åˆ—è¡¨
    function loadGroups() {
        var container = document.getElementById('groupList');
        var html = '';
        groups.forEach(function(group) {
            html += `
                <div class="group-item">
                    ${group}ç»„
                    <span class="remove-group" onclick="removeGroup('${group}')">âœ•</span>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // æ˜¾ç¤ºæ·»åŠ ç»„åˆ«å¼¹çª—
    function showAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'block';
        document.getElementById('newGroupName').value = '';
    }

    function hideAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'none';
    }

    // æ·»åŠ ç»„åˆ«
    function addGroup() {
        var newGroup = document.getElementById('newGroupName').value.toUpperCase();
        if (!newGroup || newGroup.length !== 1) {
            showAlert('ç»„åˆ«å¿…é¡»æ˜¯å•ä¸ªå¤§å†™å­—æ¯', 'error');
            return;
        }
        if (groups.includes(newGroup)) {
            showAlert('ç»„åˆ«å·²å­˜åœ¨', 'error');
            return;
        }
        groups.push(newGroup);
        groups.sort();
        loadGroups();
        updateGroupSelect();
        hideAddGroupModal();
        showAlert('ç»„åˆ«æ·»åŠ æˆåŠŸ', 'success');
    }

    // åˆ é™¤ç»„åˆ«
    function removeGroup(group) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤ç»„åˆ« ' + group + ' å—ï¼Ÿ')) {
            return;
        }
        groups = groups.filter(g => g !== group);
        loadGroups();
        updateGroupSelect();
        showAlert('ç»„åˆ«å·²åˆ é™¤', 'success');
    }

    // æ˜¾ç¤ºæ¸…ç©ºæ•°æ®åº“å¼¹çª—
    function showClearDatabaseModal() {
        document.getElementById('clearDatabaseModal').style.display = 'block';
        document.getElementById('clearConfirmInput').value = '';
    }

    function hideClearDatabaseModal() {
        document.getElementById('clearDatabaseModal').style.display = 'none';
    }

    // æ¸…ç©ºæ•°æ®åº“
    function clearDatabase() {
        var confirmText = document.getElementById('clearConfirmInput').value;

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/clear-database', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('æ•°æ®åº“å·²æ¸…ç©ºï¼', 'success');
                    hideClearDatabaseModal();
                    // åˆ·æ–°æ‰€æœ‰è¡¨æ ¼
                    loadBundleTable();
                    loadAllocations();
                    loadPendingSubmissions();
                } else {
                    showAlert('æ¸…ç©ºå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            confirmText: confirmText
        }));
    }

    // åŠ è½½å¾…å®¡æ ¸æäº¤
    function loadPendingSubmissions() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/pending-submissions', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    var tbody = document.getElementById('auditBody');

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— å¾…å®¡æ ¸æäº¤</td></tr>';
                        return;
                    }

                    var html = '';
                    for (var i = 0; i < data.length; i++) {
                        var sub = data[i];
                        var date = new Date(sub.createdAt).toLocaleString('zh-CN');

                        // æ ¼å¼åŒ–æ¨è½¦æ˜ç»†
                        var pushDetails = '';
                        if (sub.pushDetails && sub.pushDetails.length > 0) {
                            pushDetails = sub.pushDetails.map(d => d.productCode + ':' + d.quantity).join(', ');
                        } else {
                            pushDetails = 'æ— ';
                        }

                        // æ ¼å¼åŒ–è‡ªå¸¦å†·æ˜ç»†
                        var coldDetails = '';
                        if (sub.selfColdDetails && sub.selfColdDetails.length > 0) {
                            coldDetails = sub.selfColdDetails.map(d => d.productCode + ':' + d.quantity).join(', ');
                        } else {
                            coldDetails = 'æ— ';
                        }

                        // åœ¨ loadPendingSubmissions å‡½æ•°ä¸­
                        html += '<tr>' +
                            '<td>' + sub.cn + '</td>' +
                            '<td>' + sub.group_text + '</td>' +
                            '<td>' + sub.pushType + '</td>' +
                            '<td>' + pushDetails + '</td>' +
                            '<td>' + formatImageGallery(sub.pushImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                            '<td>' + coldDetails + '</td>' +
                            '<td>' + formatImageGallery(sub.selfColdImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                            '<td>' + date + '</td>' +
                            '<td>' +
                            '<button class="audit-btn" onclick="approveSubmission(\'' + sub.id + '\')">é€šè¿‡</button>' +
                            '<button class="reject-btn" onclick="rejectSubmission(\'' + sub.id + '\')">æ‹’ç»</button>' +
                            '</td>' +
                            '</tr>';
                    }
                    tbody.innerHTML = html;
                } else {
                    console.error('åŠ è½½å¾…å®¡æ ¸æäº¤å¤±è´¥:', xhr.status);
                    document.getElementById('auditBody').innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">åŠ è½½å¤±è´¥</td></tr>';
                }
            }
        };
        xhr.send();
    }

    // æ˜¾ç¤ºå®¡æ ¸å¼¹çª—
    function showAuditModal(id) {
        var submission = pendingSubmissions.find(s => s.id === id);
        if (!submission) return;

        var content = document.getElementById('auditContent');
        content.innerHTML = `
            <p><strong>CN:</strong> ${submission.cn}</p>
            <p><strong>ç»„åˆ«:</strong> ${submission.group}</p>
            <p><strong>æ¨è½¦ç±»å‹:</strong> ${submission.pushType}</p>
            <p><strong>æ¨è½¦æ˜ç»†:</strong> ${submission.pushDetails || 'æ— '}</p>
            <p><strong>è‡ªå¸¦å†·æ˜ç»†:</strong> ${submission.selfColdDetails || 'æ— '}</p>
        `;

        document.getElementById('auditModal').style.display = 'block';
        window.currentAuditId = id;
    }

    function hideAuditModal() {
        document.getElementById('auditModal').style.display = 'none';
    }

    // é€šè¿‡å®¡æ ¸
    function approveSubmission(id) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/approve-submission/' + id, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('å®¡æ ¸é€šè¿‡ï¼', 'success');
                    loadPendingSubmissions();  // åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
                    loadBundleTable();          // åˆ·æ–°æ†è¡¨
                } else {
                    showAlert('æ“ä½œå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // æ‹’ç»å®¡æ ¸
    function rejectSubmission(id) {
        if (!confirm('ç¡®å®šè¦æ‹’ç»è¿™æ¡æäº¤å—ï¼Ÿ')) {
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/admin/reject-submission/' + id, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('å·²æ‹’ç»', 'success');
                    loadPendingSubmissions();  // åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
                } else {
                    showAlert('æ“ä½œå¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(message, type) {
        var alert = document.getElementById('alert');
        alert.className = 'alert ' + type;
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(function() {
            alert.style.display = 'none';
        }, 3000);
    }


    // åŠ è½½å›¢å‘˜æ†è¡¨
    function loadBundleTable() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/bundle-table', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var tbody = document.getElementById('bundleBody');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14" style="text-align: center;">æš‚æ— åˆ†é…è®°å½•</td></tr>';
                    return;
                }

                var html = '';
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var statusClass = item.status === 'å·²æäº¤' ? 'status-submitted' : 'status-pending';

                    // åœ¨ loadBundleTable å‡½æ•°ä¸­ï¼Œä¿®æ”¹å›¾ç‰‡æ˜¾ç¤ºéƒ¨åˆ†
                    html += '<tr>' +
                        '<td><strong>' + item.cn + '</strong></td>' +
                        '<td>' + item.group + '</td>' +
                        '<td>' + item.productCode + '</td>' +
                        '<td>' + item.quantity + '</td>' +
                        '<td>' + (item.rate > 0 ? '1k' + item.rate : 'æ— æ†') + '</td>' +
                        '<td class="bundle-highlight">' + item.originalBundles + '</td>' +
                        '<td class="' + statusClass + '">' + item.status + '</td>' +
                        '<td>' + (item.pushType || '') + '</td>' +
                        '<td>' + (item.pushDetails || '') + '</td>' +
                        '<td>' + formatImageGallery(item.pushImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                        '<td>' + (item.selfColdDetails || '') + '</td>' +
                        '<td>' + formatImageGallery(item.selfColdImages) + '</td>' +  // ä¿®æ”¹è¿™é‡Œ
                        '<td class="bundle-highlight">' + (item.releaseBundles || 0) + '</td>' +
                        '<td class="bundle-highlight">' + (item.finalBundles || 0) + '</td>' +
                        '</tr>';
                }
                tbody.innerHTML = html;
            }
        };
        xhr.send();
    }
    // æ ¼å¼åŒ–å›¾ç‰‡æ˜¾ç¤ºä¸ºç¼©ç•¥å›¾åˆ—è¡¨
    function formatImageGallery(images) {
        if (!images || images.length === 0) return 'æ— ';

        var html = '<div class="image-gallery">';
        for (var i = 0; i < images.length; i++) {
            var imgUrl = '/uploads/' + images[i];
            html += '<img src="' + imgUrl + '" onclick="previewImage(\'' + imgUrl + '\');event.stopPropagation();">';
        }
        html += '</div>';
        return html;
    }

    // å›¾ç‰‡é¢„è§ˆå‡½æ•°
    function previewImage(src) {
        document.getElementById('previewImage').src = src;
        document.getElementById('imagePreviewModal').style.display = 'block';
    }
    // åŠ è½½åˆ†é…è®°å½•
    function loadAllocations() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/allocations', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var tbody = document.getElementById('allocationBody');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš‚æ— åˆ†é…è®°å½•</td></tr>';
                    return;
                }

                var html = '';
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var date = new Date(item.createdAt).toLocaleString('zh-CN');
                    var details = '';
                    for (var j = 0; j < item.allocations.length; j++) {
                        if (j > 0) details += 'ï¼Œ';
                        details += item.allocations[j].cn + ':' + item.allocations[j].quantity;
                    }

                    html += '<tr>' +
                        '<td>' + date + '</td>' +
                        '<td>' + item.group_text + '</td>' +
                        '<td>' + item.productCode + '</td>' +
                        '<td>' + details + '</td>' +
                        '<td>' +
                        '<button class="edit-btn" onclick="editAllocation(\'' + item.id + '\')">ç¼–è¾‘</button> ' +
                        '<button class="delete-btn" onclick="deleteAllocation(\'' + item.id + '\')">åˆ é™¤</button>' +
                        '</td>' +
                        '</tr>';
                }
                tbody.innerHTML = html;
            }
        };
        xhr.send();
    }

    // åˆ é™¤åˆ†é…
    function deleteAllocation(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åˆ†é…è®°å½•å—ï¼Ÿ')) {
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/admin/allocations/' + id, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('åˆ é™¤æˆåŠŸï¼', 'success');
                    loadAllocations();
                    loadBundleTable();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send();
    }

    // ç¼–è¾‘åˆ†é…
    function editAllocation(id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/admin/allocations', true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                var allocation = data.find(a => a.id === id);

                if (allocation) {
                    // ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ text input è€Œä¸æ˜¯ select
                    document.querySelector('input[name="group"]').value = allocation.group_text;
                    document.getElementById('productCode').value = allocation.productCode;

                    var container = document.getElementById('allocationItems');
                    container.innerHTML = '';

                    for (var i = 0; i < allocation.allocations.length; i++) {
                        var item = allocation.allocations[i];
                        var newItem = document.createElement('div');
                        newItem.className = 'allocation-item';
                        newItem.innerHTML = `
                        <input type="text" name="allocationCn" value="${item.cn}" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" value="${item.quantity}" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    `;
                        container.appendChild(newItem);
                    }

                    var form = document.getElementById('allocationForm');
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        updateAllocation(id);
                    };

                    showTab('allocation');
                }
            }
        };
        xhr.send();
    }

    // æ›´æ–°åˆ†é…
    function updateAllocation(id) {
        // ä¿®æ”¹è¿™é‡Œï¼šä» text input è·å–å€¼
        var groupInput = document.querySelector('input[name="group"]');
        var group = groupInput.value.toUpperCase();

        var productCode = document.getElementById('productCode').value;
        var allocationCns = document.getElementsByName('allocationCn');
        var allocationQtys = document.getElementsByName('allocationQuantity');

        var allocations = [];
        for (var i = 0; i < allocationCns.length; i++) {
            if (allocationCns[i].value && allocationQtys[i].value) {
                allocations.push({
                    cn: allocationCns[i].value,
                    quantity: parseInt(allocationQtys[i].value)
                });
            }
        }

        if (allocations.length === 0) {
            showAlert('è¯·è‡³å°‘å¡«å†™ä¸€æ¡åˆ†é…', 'error');
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('PUT', '/api/admin/allocations/' + id, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('æ›´æ–°æˆåŠŸï¼', 'success');

                    document.getElementById('allocationForm').reset();
                    document.getElementById('allocationItems').innerHTML = `
                    <div class="allocation-item">
                        <input type="text" name="allocationCn" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    </div>
                `;

                    document.getElementById('allocationForm').onsubmit = function(e) {
                        e.preventDefault();
                        submitAllocation();
                    };

                    loadAllocations();
                    loadBundleTable();
                } else {
                    showAlert('æ›´æ–°å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            group: group,
            productCode: productCode,
            allocations: allocations
        }));
    }

    // æ·»åŠ åˆ†é…é¡¹
    function addAllocationItem() {
        var container = document.getElementById('allocationItems');
        var newItem = document.createElement('div');
        newItem.className = 'allocation-item';
        newItem.innerHTML = `
            <input type="text" name="allocationCn" placeholder="CN" required>
            <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
            <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
        `;
        container.appendChild(newItem);
    }

    // åˆ é™¤åˆ†é…é¡¹
    function removeAllocationItem(btn) {
        var item = btn.parentElement;
        if (item.parentElement.children.length > 1) {
            item.remove();
        } else {
            showAlert('è‡³å°‘ä¿ç•™ä¸€é¡¹', 'error');
        }
    }

    // æäº¤åˆ†é…
    function submitAllocation() {
        // ä¿®æ”¹è¿™é‡Œï¼šä» text input è·å–å€¼
        var groupInput = document.querySelector('input[name="group"]');
        var group = groupInput.value.toUpperCase();

        var productCode = document.getElementById('productCode').value;
        var allocationCns = document.getElementsByName('allocationCn');
        var allocationQtys = document.getElementsByName('allocationQuantity');

        var allocations = [];
        for (var i = 0; i < allocationCns.length; i++) {
            if (allocationCns[i].value && allocationQtys[i].value) {
                allocations.push({
                    cn: allocationCns[i].value,
                    quantity: parseInt(allocationQtys[i].value)
                });
            }
        }

        if (allocations.length === 0) {
            showAlert('è¯·è‡³å°‘å¡«å†™ä¸€æ¡åˆ†é…', 'error');
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/allocations', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showAlert('åˆ†é…æäº¤æˆåŠŸï¼', 'success');
                    document.getElementById('allocationForm').reset();
                    document.getElementById('allocationItems').innerHTML = `
                    <div class="allocation-item">
                        <input type="text" name="allocationCn" placeholder="CN" required>
                        <input type="number" name="allocationQuantity" placeholder="æ•°é‡" min="1" required>
                        <button type="button" class="remove-btn" onclick="removeAllocationItem(this)">åˆ é™¤</button>
                    </div>
                `;
                    loadAllocations();
                    loadBundleTable();
                } else {
                    showAlert('æäº¤å¤±è´¥ï¼š' + result.error, 'error');
                }
            }
        };
        xhr.send(JSON.stringify({
            group: group,
            productCode: productCode,
            allocations: allocations
        }));
    }

    document.getElementById('allocationForm').onsubmit = function(e) {
        e.preventDefault();
        submitAllocation();
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadBundleTable();
    });
</script>
</body>
</html>